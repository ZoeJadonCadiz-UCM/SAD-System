<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Payment Dashboard</title>
        <link rel="stylesheet" href="../css/payments.css" />
    </head>
    <body>

    <nav class="navbar">
        <div class="nav-left">
            <a href="account2.html" class="nav-btn active-page">Account</a>
        </div>

        <div class="nav-right">
            <a href="dashboard2.html" class="nav-btn">Dashboard</a>
            <a href="payments2.html" class="nav-btn1">Payments</a>
            <a href="room.html" class="nav-btn">Room</a>
            <a href="Upkeep2.html" class="nav-btn">UpKeep</a>
            <a href="../../login/html/login.html" class="nav-btn logout">Log-out</a>
        </div>
    </nav>

    <div class="container">

        <div class="card">
            <span class="card-header">Due Payment</span>

            <div class="search-box">
                <input class="search-input" placeholder="Search..." />
            </div>

            <div class="payment-boxes">
                <div class="box">
                    <div>Monthly Rent</div>
                    <div class="price-green" id="totalRevenue">$0</div>
                </div>

                <div class="box">
                    <div>Pending Payments<br>(Overdues)</div>
                    <div class="price-orange" id="pendingPayments">$0</div>
                </div>
            </div>
        </div>

        <div class="card">
            <span class="card-header">Payment History</span>

            <table>
                <thead>
                    <tr>
                        <th>Monthly Payment</th>
                        <th>Due Date</th>
                        <th>Paid On</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="paymentsTableBody">
                </tbody>
            </table>

            <div class="next-payment" id="nextPaymentDue"></div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tbody = document.getElementById('paymentsTableBody');
            const totalRevenueEl = document.getElementById('totalRevenue');
            const pendingPaymentsEl = document.getElementById('pendingPayments');
            const nextPaymentEl = document.getElementById('nextPaymentDue');

            const FIXED_AMOUNT = 450;

            const tenants = JSON.parse(localStorage.getItem('tenants')) || {};
            const currentUser = localStorage.getItem('currentUser');
            const user = tenants[currentUser];

            if (!user || user.status !== "Occupied") {
                tbody.innerHTML = `<tr><td colspan="4">No active payments for current user.</td></tr>`;
                totalRevenueEl.textContent = `$0`;
                pendingPaymentsEl.textContent = `$0`;
                if(nextPaymentEl) nextPaymentEl.textContent = '';
                return;
            }

            // Load or initialize payment history
            const allPaymentsKey = `payments_${currentUser}`;
            let allPayments = JSON.parse(localStorage.getItem(allPaymentsKey)) || [];

            // Add current month if not already added
            const today = new Date();
            const thisMonthStr = `${today.getFullYear()}-${today.getMonth() + 1}`;
            if (!allPayments.some(p => p.month === thisMonthStr)) {
                allPayments.push({
                    month: thisMonthStr,
                    rent: user.rent,
                    dueDate: user.dueDate || today.toISOString(),
                    lastPayment: user.paymentStatus === "Paid" ? today.toISOString() : null,
                    paymentStatus: user.paymentStatus
                });
                localStorage.setItem(allPaymentsKey, JSON.stringify(allPayments));
            }

            const formatDate = (dateStr) => {
                const d = new Date(dateStr);
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const year = d.getFullYear().toString().slice(-2);
                return `${month}-${day}-${year}`;
            };

            // Render all payments
            let totalRevenue = 0;
            let pendingPayments = 0;
            tbody.innerHTML = '';

            allPayments.forEach(p => {
                const tr = document.createElement('tr');
                const statusClass = p.paymentStatus.toLowerCase().replace(' ', '-');
                tr.innerHTML = `
                    <td>$${p.rent}</td>
                    <td>${formatDate(p.dueDate)}</td>
                    <td>${p.lastPayment ? formatDate(p.lastPayment) : '------'}</td>
                    <td><span class="tag ${statusClass}">${p.paymentStatus}</span></td>
                `;
                tbody.appendChild(tr);

                if(p.paymentStatus === "Paid") totalRevenue += FIXED_AMOUNT;
                else pendingPayments += FIXED_AMOUNT;
            });

            totalRevenueEl.textContent = `$${totalRevenue}`;
            pendingPaymentsEl.textContent = `$${pendingPayments}`;
            if(nextPaymentEl) nextPaymentEl.textContent = `Next Payment Due: ${formatDate(user.dueDate || today)}`;
        });

        </script>

    </body>
</html>
