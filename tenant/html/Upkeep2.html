<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Maintenance & UpKeep</title>
        <link rel="stylesheet" href="../css/Upkeep.css">
        <style>
            .priority-btn.selected { border: 2px solid #000; }
            .priority-btn { cursor: pointer; }
        </style>
    </head>

    <body>

    <nav class="navbar">
        <div class="nav-left">
            <a href="account2.html" class="nav-btn active-page">Account</a>
        </div>
        <div class="nav-right">
            <a href="dashboard2.html" class="nav-btn">Dashboard</a>
            <a href="payments2.html" class="nav-btn">Payments</a>
            <a href="room.html" class="nav-btn">Room</a>
            <a href="Upkeep2.html" class="nav-btn1">UpKeep</a>
            <a href="../../login/html/login.html" class="nav-btn" onclick="localStorage.removeItem('currentTenant')">Log-out</a>
        </div>
    </nav>

    <div class="container">

        <!-- Submit Maintenance Form -->
        <div class="card" id="maintenanceForm">
            <span class="card-header">Request Maintenance</span>

            <div class="request-row">
                <div class="issue-block">
                    <label class="lbl">Describe the issue:</label>
                    <textarea class="issue-text" id="issueText" placeholder="Write here..."></textarea>
                </div>

                <div class="priority-block">
                    <label class="lbl">Priority:</label>
                    <div class="priority-btn low" data-priority="Low">Low</div>
                    <div class="priority-btn medium" data-priority="Medium">Medium</div>
                    <div class="priority-btn urgent" data-priority="Urgent">Urgent</div>
                    <button class="send-btn" id="sendBtn">SEND</button>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="card">
            <span class="card-header">Maintenance & UpKeep</span>

            <div class="search-box">
                <input class="search-input" placeholder="Search..." id="searchInput">
            </div>

            <div class="summary-row">
                <div class="summary-card">Pending Request <span class="count orange" id="pendingCount">0</span></div>
                <div class="summary-card">In Progress <span class="count blue" id="inProgressCount">0</span></div>
                <div class="summary-card">Completed <span class="count green" id="completedCount">0</span></div>
                <div class="summary-card">Urgent Request <span class="count red" id="urgentCount">0</span></div>
            </div>
        </div>

        <!-- Requests Table -->
        <div class="card">
            <span class="card-header">Maintenance Requests</span>

            <table id="requestsTable">
                <tr>
                    <th>Room</th>
                    <th>Tenant Name</th>
                    <th>Issue</th>
                    <th>Priority</th>
                    <th>Date Received</th>
                    <th>Status</th>
                </tr>
            </table>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // Load the currently logged-in tenant
        const tenant = JSON.parse(localStorage.getItem('currentTenant')) || null;
        console.log("Loaded tenant:", tenant);

        // DOM elements
        const issueText = document.getElementById('issueText');
        const sendBtn = document.getElementById('sendBtn');
        const requestsTable = document.getElementById('requestsTable');
        const searchInput = document.getElementById('searchInput');
        let selectedPriority = 'Low';

        // Priority selection visual
        document.querySelectorAll('.priority-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                selectedPriority = btn.dataset.priority;
                document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
            });
        });

        // Load existing requests from storage
        let allRequests = JSON.parse(localStorage.getItem('requests')) || [];

        /* ============================
        Render Requests Table
        ============================= */
        function renderRequests() {
            requestsTable.innerHTML = `
                <tr>
                    <th>Room</th>
                    <th>Tenant Name</th>
                    <th>Issue</th>
                    <th>Priority</th>
                    <th>Date Received</th>
                    <th>Status</th>
                </tr>
            `;

            // Filter only requests for this tenant
            const tenantRequests = tenant ?
                allRequests.filter(r => r.room === tenant.room) :
                allRequests;

            tenantRequests.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.room || 'N/A'}</td>
                    <td>${r.name || 'Unknown'}</td>
                    <td>${r.issue || 'No description'}</td>
                    <td><span class="tag ${r.priority.toLowerCase()}">${r.priority}</span></td>
                    <td>${r.date || 'N/A'}</td>
                    <td><span class="status ${r.status.toLowerCase().replace(' ', '')}">${r.status}</span></td>
                `;
                requestsTable.appendChild(tr);
            });

            updateSummary(tenantRequests);
        }

        /* ============================
        Update Summary Counts
        ============================= */
        function updateSummary(reqs) {
            document.getElementById('pendingCount').textContent =
                reqs.filter(r => r.status === 'Pending').length;

            document.getElementById('inProgressCount').textContent =
                reqs.filter(r => r.status === 'In Progress').length;

            document.getElementById('completedCount').textContent =
                reqs.filter(r => r.status === 'Completed').length;

            document.getElementById('urgentCount').textContent =
                reqs.filter(r => r.priority === 'Urgent').length;
        }

        /* ============================
        Submit a New Request
        ============================= */
        sendBtn.addEventListener('click', () => {

            if (!tenant) {
                alert('Please log in to submit a request.');
                return;
            }

            const issue = issueText.value.trim();
            if (!issue) {
                alert('Please describe the issue.');
                return;
            }

            const date = new Date().toLocaleDateString('en-GB');

            // ⬇⬇ FIXED HERE — USE tenant.room AND tenant.name
            const newRequest = {
                room: tenant.room,
                name: tenant.name,
                issue: issue,
                priority: selectedPriority,
                date: date,
                status: 'Pending'
            };

            allRequests.push(newRequest);
            localStorage.setItem('requests', JSON.stringify(allRequests));

            issueText.value = '';
            selectedPriority = 'Low';
            document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('selected'));

            renderRequests();
        });

        /* ============================
        Search Filter
        ============================= */
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            Array.from(requestsTable.rows).forEach((row, index) => {
                if (index === 0) return;
                row.style.display = row.textContent.toLowerCase().includes(query) ? '' : 'none';
            });
        });

        // Initial render
        renderRequests();
    });
    </script>

    </body>
</html>
